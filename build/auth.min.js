!function(a,b,c){"use strict";angular.module("ambersive.routerui.auth",["ambersive.db","ui.router"]),angular.module("ambersive.routerui.auth").provider("$authenticationSettings",[function(){var a={api:{baseUrl:"",url:"",except:["getById","delete","update","create"]},redirectOnError:!0,redirect401Route:"",redirect401Url:"",redirect403Route:"",redirect403Url:"",refreshTime:60};return{setValue:function(b,d){a[b]!==c&&"api"!==b&&(a[b]=d)},setApiValue:function(b,d){a.api[b]!==c&&(a.api[b]=d)},$get:function(){return{api:a.api,error401Route:a.redirect401Route,error403Route:a.redirect403Route,error401Url:a.redirect401Url,error403Url:a.redirect403Url,redirectOnError:a.redirectOnError,refreshTime:a.refreshTime}}}}]),angular.module("ambersive.routerui.auth").config(["$urlRouterProvider","$authenticationSettingsProvider","$dbSettingsProvider",function(a,b,c){a.deferIntercept()}]),angular.module("ambersive.routerui.auth").run(["$rootScope","$urlRouter","$state","$log","Auth","$authenticationSettings","DB","$dbSettings",function(b,d,e,f,g,h,i,j){i({name:"Auth",baseUrl:h.api.baseUrl,url:h.api.url,except:h.api.except}),b.$on("$locationChangeSuccess",function(a,b){}),b.$on("$stateChangeStart",function(b,d,f,i,j,k){var l=g.checkRegister(d.name),m=(h.refreshTime,{}),n=!1,o=function(){if(n===!0){var f=d.data.redirectOnLogged;f!==c&&(f.url!==c&&(a.location.href=f.url,b.preventDefault()),f.route!==c&&(e.go(f.route),b.preventDefault()))}};l===c||l.allow===c||g.preCheck(d.name)===!1?(g.register(d.name,!0),g.check(d,f,i,j,k).then(function(a){g.register(d.name,a),m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),a===!0?(o(),e.go(d,f,k)):a===!1&&n===!0?g.onError(403,b):g.onError(401,b)}),b.preventDefault()):(m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),l.allow===!1&&n===!0?g.onError(403,b):l.allow===!1&&n===!1?g.onError(401,b):l.allow===!0&&o())}),b.$on("$stateChangeSuccess",function(a,b,c,d,e,f){}),b.$on("$stateNotFound",function(a,b,c,d,e,f){}),b.$on("$stateChangeError",function(a,b,c,d,e){}),b.$on("$viewContentLoaded",function(a,b){})}]),angular.module("ambersive.routerui.auth").factory("Auth",["$q","DB","$timeout","$log","$state","$authenticationSettings","$dbSettings","$rootScope",function(a,b,d,e,f,g,h,i){var j={},k={},l={},m=function(){return{timestamp:0,allow:!1,roles:[]}},n={};return Date.now||(Date.now=function(){return(new Date).getTime()}),k.getTimestamp=function(){var a=Math.floor(Date.now()/1e3);return a},k.compare=function(a,b){return a.filter(function(a){return-1!=b.indexOf(a)})},j.getUser=function(){var a=h.storageName,b=null,c={};return"undefined"!=typeof Storage?b=localStorage.getItem(a):e.warn("ambersive.db: this browser doesn't support localStorage"),null!==b?c=n:(n={},c=n),i.$broadcast("$stateAuthenticationUser",{user:c}),c},j.setUser=function(a){n=a},j.isAuthenticated=function(){var a=j.getUser();return a.id!==c?!0:!1},j.getRoles=function(){var a=[];return n!==c&&n.roles!==c&&(a=n.roles),a},j.checkRole=function(a){var b=j.getRoles(),c=!1;return b.indexOf(a)>-1&&(c=!0),c},j.onError=function(a,b){if(a===c)return void e.warn("ambersive.routerui.auth: please define a error code for error handling");var d=function(a,b){g.redirectOnError===!0&&(b!==c&&""!==b?f.go(b):e.warn("ambersive.routerui.auth: please define a route for "+a+" errors"))};switch(a){case 403:var h=g.error403Route;d(403,h),i.$broadcast("$statePermissionDenied",{code:a});break;default:var j=g.error401Route;d(401,j),i.$broadcast("$statePermissionDenied",{code:a})}b.preventDefault()},j.clearRegister=function(){return l={}},j.getRegister=function(){return l},j.getRegisterEntry=function(a){return l[a]!==c?l[a]:void 0},j.checkRegister=function(a,b){b===c&&(b=!0);var d=j.getRegisterEntry(a);return d},j.register=function(a,b,d){var e=new m;return d===c&&(d=k.getTimestamp()),e.timestamp=d,e.allow=b,e.roles=f.get(a).data.roles,l[a]=e,e},j.preCheck=function(a){var b=!1,d=l[a],e=g.refreshTime;if(d!==c){e===c&&(e=0);var f=d.timestamp+e;k.getTimestamp()<=f&&(b=!0)}return b},j.check=function(b,d,e,f,g){var h=a.defer(),i=!1,k=[],l=function(){h.resolve(i)},m=function(){var a=!1;return a=k.length>0?k.some(j.checkRole):!0};return j.callAPI(b).then(function(){b!==c&&b.data!==c&&b.data.roles!==c&&angular.isArray(b.data.roles)&&(k=k.concat(b.data.roles)),i=m(),l(i)}),h.promise},j.callAPI=function(d){var e=a.defer(),f=g.api.baseUrl;g.api.url;return f!==c?b("Auth").get().then(function(a){200===a.status&&(n=a.data),i.$broadcast("$stateAuthenticationUser",{user:n}),e.resolve()},function(a){n={},i.$broadcast("$stateAuthenticationUser",{user:n}),e.resolve()}):e.resolve(),e.promise},j}])}(window,document,void 0);