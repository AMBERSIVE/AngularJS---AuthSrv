!function(a,b,c){"use strict";angular.module("ambersive.routerui.auth",["ambersive.db","ui.router"]),angular.module("ambersive.routerui.auth").provider("$authenticationSettings",[function(){var a={api:{baseUrl:"",url:"",except:["getById","delete","update","create"]},redirectOnError:!0,redirect401Route:"",redirect401Url:"",redirect403Route:"",redirect403Url:"",refreshTime:60};return{setValue:function(b,d){a[b]!==c&&"api"!==b&&(a[b]=d)},setApiValue:function(b,d){a.api[b]!==c&&(a.api[b]=d)},$get:function(){return{api:a.api,error401Route:a.redirect401Route,error403Route:a.redirect403Route,error401Url:a.redirect401Url,error403Url:a.redirect403Url,redirectOnError:a.redirectOnError,refreshTime:a.refreshTime}}}}]),angular.module("ambersive.routerui.auth").config(["$urlRouterProvider","$authenticationSettingsProvider","$dbSettingsProvider",function(a,b,c){a.deferIntercept()}]),angular.module("ambersive.routerui.auth").run(["$rootScope","$urlRouter","$state","$log","Auth","$authenticationSettings","DB",function(b,d,e,f,g,h,i){i({name:"Auth",baseUrl:h.api.baseUrl,url:h.api.url,except:h.api.except}),b.$on("$locationChangeSuccess",function(a,b){}),b.$on("$stateChangeStart",function(b,d,f,i,j,k){var l=g.checkRegister(d.name),m=(h.refreshTime,{}),n=!1,o=function(){if(n===!0){var f=d.data.redirectOnLogged;f!==c&&(f.url!==c&&(a.location.href=f.url,b.preventDefault()),f.route!==c&&(e.go(f.route),b.preventDefault()))}};l===c||l.allow===c||g.preCheck(d.name)===!1?(g.check(d,f,i,j,k).then(function(a){g.register(d.name,a),m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),a===!0?(o(),e.go(d,f,k)):a===!1&&n===!0?g.onError(403,b):g.onError(401,b)}),b.preventDefault()):(m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),l.allow===!1&&n===!0?g.onError(403,b):l.allow===!1&&n===!1?g.onError(401,b):l.allow===!0&&o())}),b.$on("$stateChangeSuccess",function(a,b,c,d,e,f){}),b.$on("$stateNotFound",function(a,b,c,d,e,f){}),b.$on("$stateChangeError",function(a,b,c,d,e){}),b.$on("$viewContentLoaded",function(a,b){})}]),angular.module("ambersive.routerui.auth").factory("Auth",["$q","DB","$timeout","$log","$state","$authenticationSettings","$rootScope",function(a,b,d,e,f,g,h){var i={},j={},k={},l=function(){return{timestamp:0,allow:!1,roles:[]}},m={};return Date.now||(Date.now=function(){return(new Date).getTime()}),j.getTimestamp=function(){var a=Math.floor(Date.now()/1e3);return a},j.compare=function(a,b){return a.filter(function(a){return-1!=b.indexOf(a)})},i.getUser=function(){return m},i.getRoles=function(){var a=[];return m!==c&&m.roles!==c&&(a=m.roles),a},i.checkRole=function(a){var b=i.getRoles(),c=!1;return b.indexOf(a)>-1&&(c=!0),c},i.onError=function(a,b){if(a===c)return void e.warn("ambersive.routerui.auth: please define a error code for error handling");var d=function(a,b){g.redirectOnError===!0&&(b!==c&&""!==b?f.go(b):e.warn("ambersive.routerui.auth: please define a route for "+a+" errors"))};switch(a){case 403:var i=g.error403Route;d(403,i),h.$broadcast("$statePermissionDenied",{code:a});break;default:var j=g.error401Route;d(401,j),h.$broadcast("$statePermissionDenied",{code:a})}b.preventDefault()},i.clearRegister=function(){return k={}},i.getRegister=function(){return k},i.getRegisterEntry=function(a){return k[a]!==c?k[a]:void 0},i.checkRegister=function(a,b){b===c&&(b=!0);var d=i.getRegisterEntry(a);return d},i.register=function(a,b,d){var e=new l;return d===c&&(d=j.getTimestamp()),e.timestamp=d,e.allow=b,e.roles=f.get(a).data.roles,k[a]=e,e},i.preCheck=function(a){var b=!1,d=k[a],e=g.refreshTime;if(d!==c){e===c&&(e=0);var f=d.timestamp+e;j.getTimestamp()<=f&&(b=!0)}return b},i.check=function(b,d,e,f,g){var h=a.defer(),j=!1,k=[],l=function(){h.resolve(j)},m=function(){var a=!1;return a=k.length>0?k.some(i.checkRole):!0};return i.callAPI().then(function(){b!==c&&b.data!==c&&b.data.roles!==c&&angular.isArray(b.data.roles)&&(k=k.concat(b.data.roles)),j=m(),l(j)}),h.promise},i.callAPI=function(){var d=a.defer(),e=g.api.baseUrl;g.api.url;return e!==c?b("Auth").get().then(function(a){200===a.status&&(m=a.data),d.resolve()},function(a){m={},d.resolve()}):d.resolve(),d.promise},i}])}(window,document,void 0);