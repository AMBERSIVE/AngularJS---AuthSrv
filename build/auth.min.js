!function(a,b,c){"use strict";angular.module("ambersive.routerui.auth",["ambersive.db","ui.router"]),angular.module("ambersive.routerui.auth").provider("$authenticationSettings",[function(){var a={api:{baseUrl:"",url:"",except:["getById","delete","update","create"]},redirectOnError:!0,redirect401Route:"",redirect401Url:"",redirect403Route:"",redirect403Url:"",redirect404Route:"",redirect404Url:"",redirect500Route:"",redirect500Url:"",refreshTime:60,tokenUseage:!0};return{setValue:function(b,d){a[b]!==c&&"api"!==b&&(a[b]=d)},setApiValue:function(b,d){a.api[b]!==c&&(a.api[b]=d)},$get:function(){return{api:a.api,error401Route:a.redirect401Route,error403Route:a.redirect403Route,error404Route:a.redirect404Route,error500Route:a.redirect500Route,error401Url:a.redirect401Url,error403Url:a.redirect403Url,error404Url:a.redirect404Url,error500Url:a.redirect500Url,redirectOnError:a.redirectOnError,refreshTime:a.refreshTime,tokenUseage:a.tokenUseage}}}}]),angular.module("ambersive.routerui.auth").config(["AuthProvider","$urlRouterProvider","$authenticationSettingsProvider","$dbSettingsProvider",function(a,b,c,d){b.deferIntercept(),b.otherwise(function(b,c){a.$get().onError(404)})}]),angular.module("ambersive.routerui.auth").directive("permissions",["$compile","$animate","Auth",function(a,d,e){var f={};return f.restrict="A",f.transclude="element",f.scope={permissions:"="},f.controller=["Auth","$scope","$rootScope",function(a,b,d){var e=b.permissions,f=a.getUser();b.display=!0,b.user=f,b.check=function(){var a=!0;return e.length>0&&(a=b.permissions.some(function(a){return f.roles!==c&&f.roles.indexOf(a)>-1})),a},d.$on("$stateAuthenticationUser",function(a,d){d.user!==c&&(f=d.user,b.user=f),b.check()})}],f.link=function(a,c,e,f,g){function h(a){for(var b,c=a[0],d=a[a.length-1],e=1;c!==d&&(c=c.nextSibling);e++)(b||a[e]!==c)&&(b||(b=jqLite(slice.call(a,0,e))),b.push(c));return b||a}var i,j,k;a.$watch("user",function(f){var l=a.check();j||l!==!0?(k&&(k.remove(),k=null),j&&(j.$destroy(),j=null),i&&(k=h(i.clone),d.leave(k).then(function(){k=null}),i=null)):g(function(a,f){j=f,a[a.length++]=b.createComment(" end ngIf: "+e.ngIf+" "),i={clone:a},d.enter(a,c.parent(),c)})})},f}]),angular.module("ambersive.routerui.auth").run(["$rootScope","$urlRouter","$state","$log","Auth","$authenticationSettings","DB","$dbSettings",function(b,d,e,f,g,h,i,j){i({name:"Auth",baseUrl:h.api.baseUrl,url:h.api.url,except:h.api.except}),b.$on("$locationChangeSuccess",function(a,b){}),b.$on("$stateChangeStart",function(b,d,f,i,j,k){var l=g.checkRegister(d.name),m=(h.refreshTime,{}),n=!1,o=function(){if(n===!0){var f=d.data.redirectOnLogged;f!==c&&(f.url!==c&&(a.location.href=f.url,b.preventDefault()),f.route!==c&&(e.go(f.route),b.preventDefault()))}};l===c||l.allow===c||g.preCheck(d.name)===!1?(g.register(d.name,!0),g.check(d,f,i,j,k).then(function(a){g.register(d.name,a),m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),a===!0?(o(),e.go(d,f,k)):a===!1&&n===!0?g.onError(403,b):g.onError(401,b)}),b.preventDefault()):(m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),l.allow===!1&&n===!0?g.onError(403,b):l.allow===!1&&n===!1?g.onError(401,b):l.allow===!0&&o())}),b.$on("$stateNotFound",function(a,b,c,d,e,f){g.onError(404,a)}),b.$on("$stateChangeError",function(a,b,c,d,e){g.onError(500,a)})}]),angular.module("ambersive.routerui.auth").factory("Auth",["$q","DB","$timeout","$window","$log","$state","$stateParams","$authenticationSettings","$dbSettings","$rootScope",function(a,b,d,e,f,g,h,i,j,k){var l={},m={},n={},o=function(){return{timestamp:0,allow:!1,roles:[]}},p={};return Date.now||(Date.now=function(){return(new Date).getTime()}),m.getTimestamp=function(){var a=Math.floor(Date.now()/1e3);return a},m.compare=function(a,b){return a.filter(function(a){return-1!=b.indexOf(a)})},l.getUser=function(){var a=j.storageName,b=j.tokenUseage,c=null,d={};return b===!0?("undefined"!=typeof Storage?c=localStorage.getItem(a):f.warn("ambersive.db: this browser doesn't support localStorage"),null!==c?d=p:(p={},d=p)):d=p,d},l.setUser=function(a){p=a,k.$broadcast("$stateAuthenticationUser",{user:p})},l.resetUser=function(){var a=j.storageName;"undefined"!=typeof Storage?localStorage.setItem(a,null):f.warn("ambersive.db: this browser doesn't support localStorage"),p={},l.reCheck(),k.$broadcast("$stateAuthenticationUser",{user:p})},l.hasRole=function(a){var b=!1;return p.roles!==c&&(b=p.roles.indexOf(a)>-1),b},l.isAuthenticated=function(){var a=l.getUser();return a.id!==c?!0:!1},l.getRoles=function(){var a=[];return p!==c&&p.roles!==c&&(a=p.roles),a},l.checkRole=function(a){var b=l.getRoles(),c=!1;return b.indexOf(a)>-1&&(c=!0),c},l.onError=function(a,b){if(a===c)return void f.warn("ambersive.routerui.auth: please define a error code for error handling");var d=function(a){var b=i["error"+a+"Url"],d=i["error"+a+"Route"];return b!==c&&""!==b?void(e.location.href=b):void(i.redirectOnError===!0&&(d!==c&&""!==d?g.go(d):f.warn("ambersive.routerui.auth: please define a route for "+a+" errors")))};switch(a){case 401:case 403:d(a),k.$broadcast("$statePermissionDenied",{code:a});break;default:d(a)}b!==c&&b.preventDefault()},l.clearRegister=function(){return n={}},l.getRegister=function(){return n},l.getRegisterEntry=function(a){return n[a]!==c?n[a]:void 0},l.checkRegister=function(a,b){b===c&&(b=!0);var d=l.getRegisterEntry(a);return d},l.register=function(a,b,d){var e=new o;return d===c&&(d=m.getTimestamp()),e.timestamp=d,e.allow=b,e.roles=g.get(a).data.roles,n[a]=e,e},l.preCheck=function(a){var b=!1,d=n[a],e=i.refreshTime;if(d!==c){e===c&&(e=0);var f=d.timestamp+e;m.getTimestamp()<=f&&(b=!0)}return b},l.reCheck=function(){l.check(g,h)},l.check=function(b,d,e,f,g){var h=a.defer(),i=!1,j=[],k=function(a){h.resolve(a)},m=function(){var a=!1;return a=j.length>0?j.some(l.checkRole):!0};return l.callAPI(b).then(function(){b!==c&&b.data!==c&&b.data.roles!==c&&angular.isArray(b.data.roles)&&(j=j.concat(b.data.roles)),i=m(),k(i)}),h.promise},l.callAPI=function(d){var e=a.defer(),f=i.api.baseUrl;i.api.url;return f!==c?b("Auth").get().then(function(a){200===a.status&&(p=a.data),k.user=p,k.$broadcast("$stateAuthenticationUser",{user:p}),e.resolve()},function(a){p={},k.user=p,k.$broadcast("$stateAuthenticationUser",{user:p}),e.resolve()}):e.resolve(),e.promise},k.$on("$stateAuthenticationUser",function(a,b){b.user!==c&&(p=b.user)}),l}])}(window,document,void 0);