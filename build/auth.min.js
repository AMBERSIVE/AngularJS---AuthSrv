!function(a,b,c){"use strict";angular.module("ambersive.routerui.auth",["ambersive.db","ui.router"]),angular.module("ambersive.routerui.auth").provider("$authenticationSettings",[function(){var a={api:{baseUrl:"",url:"",except:["getById","delete","update","create"]},redirectOnError:!0,redirect401Route:"",redirect401Url:"",redirect403Route:"",redirect403Url:"",redirect404Route:"",redirect404Url:"",redirect500Route:"",redirect500Url:"",refreshTime:60};return{setValue:function(b,d){a[b]!==c&&"api"!==b&&(a[b]=d)},setApiValue:function(b,d){a.api[b]!==c&&(a.api[b]=d)},$get:function(){return{api:a.api,error401Route:a.redirect401Route,error403Route:a.redirect403Route,error404Route:a.redirect404Route,error500Route:a.redirect500Route,error401Url:a.redirect401Url,error403Url:a.redirect403Url,error404Url:a.redirect404Url,error500Url:a.redirect500Url,redirectOnError:a.redirectOnError,refreshTime:a.refreshTime}}}}]),angular.module("ambersive.routerui.auth").config(["AuthProvider","$urlRouterProvider","$authenticationSettingsProvider","$dbSettingsProvider",function(a,b,c,d){b.deferIntercept(),b.otherwise(function(b,c){a.$get().onError(404)})}]),angular.module("ambersive.routerui.auth").directive("permissions",["$compile","$animate",function(a,d){var e={};return e.restrict="A",e.transclude="element",e.scope={permissions:"="},e.controller=["Auth","$scope","$rootScope",function(a,b,d){var e=b.permissions,f={};b.display=!0,b.user=f,b.check=function(){var a=!0;return e.length>0&&(a=b.permissions.some(function(a){return f.roles!==c&&f.roles.indexOf(a)>-1})),a},d.$on("$stateAuthenticationUser",function(a,d){d.user!==c&&(f=d.user,b.user=f),b.check()})}],e.link=function(a,c,e,f,g){var h,i;a.$watch("user",function(f){a.check()!==!1&&(i||g(function(a,f){i=f,a[a.length++]=b.createComment(" end ngIf: "+e.ngIf+" "),h={clone:a},d.enter(a,c.parent(),c)}))})},e}]),angular.module("ambersive.routerui.auth").run(["$rootScope","$urlRouter","$state","$log","Auth","$authenticationSettings","DB","$dbSettings",function(b,d,e,f,g,h,i,j){i({name:"Auth",baseUrl:h.api.baseUrl,url:h.api.url,except:h.api.except}),b.$on("$locationChangeSuccess",function(a,b){}),b.$on("$stateChangeStart",function(b,d,f,i,j,k){var l=g.checkRegister(d.name),m=(h.refreshTime,{}),n=!1,o=function(){if(n===!0){var f=d.data.redirectOnLogged;f!==c&&(f.url!==c&&(a.location.href=f.url,b.preventDefault()),f.route!==c&&(e.go(f.route),b.preventDefault()))}};l===c||l.allow===c||g.preCheck(d.name)===!1?(g.register(d.name,!0),g.check(d,f,i,j,k).then(function(a){g.register(d.name,a),m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),a===!0?(o(),e.go(d,f,k)):a===!1&&n===!0?g.onError(403,b):g.onError(401,b)}),b.preventDefault()):(m=g.getUser(),(m.id!==c||m.roles!==c)&&(n=!0),l.allow===!1&&n===!0?g.onError(403,b):l.allow===!1&&n===!1?g.onError(401,b):l.allow===!0&&o())}),b.$on("$stateNotFound",function(a,b,c,d,e,f){g.onError(404,a)}),b.$on("$stateChangeError",function(a,b,c,d,e){g.onError(500,a)})}]),angular.module("ambersive.routerui.auth").factory("Auth",["$q","DB","$timeout","$window","$log","$state","$authenticationSettings","$dbSettings","$rootScope",function(a,b,d,e,f,g,h,i,j){var k={},l={},m={},n=function(){return{timestamp:0,allow:!1,roles:[]}},o={};return Date.now||(Date.now=function(){return(new Date).getTime()}),l.getTimestamp=function(){var a=Math.floor(Date.now()/1e3);return a},l.compare=function(a,b){return a.filter(function(a){return-1!=b.indexOf(a)})},k.getUser=function(){var a=i.storageName,b=null,c={};return"undefined"!=typeof Storage?b=localStorage.getItem(a):f.warn("ambersive.db: this browser doesn't support localStorage"),null!==b?c=o:(o={},c=o),c},k.setUser=function(a){o=a},k.isAuthenticated=function(){var a=k.getUser();return a.id!==c?!0:!1},k.getRoles=function(){var a=[];return o!==c&&o.roles!==c&&(a=o.roles),a},k.checkRole=function(a){var b=k.getRoles(),c=!1;return b.indexOf(a)>-1&&(c=!0),c},k.onError=function(a,b){if(a===c)return void f.warn("ambersive.routerui.auth: please define a error code for error handling");var d=function(a){var b=h["error"+a+"Url"],d=h["error"+a+"Route"];return b!==c&&""!==b?void(e.location.href=b):void(h.redirectOnError===!0&&(d!==c&&""!==d?g.go(d):f.warn("ambersive.routerui.auth: please define a route for "+a+" errors")))};switch(a){case 401:case 403:d(a),j.$broadcast("$statePermissionDenied",{code:a});break;default:d(a)}b!==c&&b.preventDefault()},k.clearRegister=function(){return m={}},k.getRegister=function(){return m},k.getRegisterEntry=function(a){return m[a]!==c?m[a]:void 0},k.checkRegister=function(a,b){b===c&&(b=!0);var d=k.getRegisterEntry(a);return d},k.register=function(a,b,d){var e=new n;return d===c&&(d=l.getTimestamp()),e.timestamp=d,e.allow=b,e.roles=g.get(a).data.roles,m[a]=e,e},k.preCheck=function(a){var b=!1,d=m[a],e=h.refreshTime;if(d!==c){e===c&&(e=0);var f=d.timestamp+e;l.getTimestamp()<=f&&(b=!0)}return b},k.check=function(b,d,e,f,g){var h=a.defer(),i=!1,j=[],l=function(){h.resolve(i)},m=function(){var a=!1;return a=j.length>0?j.some(k.checkRole):!0};return k.callAPI(b).then(function(){b!==c&&b.data!==c&&b.data.roles!==c&&angular.isArray(b.data.roles)&&(j=j.concat(b.data.roles)),i=m(),l(i)}),h.promise},k.callAPI=function(d){var e=a.defer(),f=h.api.baseUrl;h.api.url;return f!==c?b("Auth").get().then(function(a){200===a.status&&(o=a.data),j.user=o,j.$broadcast("$stateAuthenticationUser",{user:o}),e.resolve()},function(a){o={},j.user=o,j.$broadcast("$stateAuthenticationUser",{user:o}),e.resolve()}):e.resolve(),e.promise},j.$on("$stateAuthenticationUser",function(a,b){b.user!==c&&(o=b.user)}),k}])}(window,document,void 0);